<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Octodon System v14.2 Auto-Detect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Orbitron:wght@900&display=swap');
        
        body { 
            background-color: #020617; 
            color: #f8fafc; 
            font-family: 'JetBrains Mono', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }

        .cyber-font { font-family: 'Orbitron', sans-serif; }
        .status-box { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .blink-red { animation: blink-red 1s infinite; background-color: rgba(239, 68, 68, 0.2); border-color: #ef4444; }
        .glow-green { box-shadow: 0 0 15px rgba(34, 197, 94, 0.3); border-color: #22c55e; background-color: rgba(20, 83, 45, 0.3); }
        .glow-yellow { box-shadow: 0 0 15px rgba(234, 179, 8, 0.3); border-color: #eab308; background-color: rgba(113, 63, 18, 0.3); }
        
        @keyframes blink-red {
            0%, 100% { box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); opacity: 1; }
            50% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.9); opacity: 0.8; }
        }

        .btn-push:active { transform: scale(0.96); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep { 0% {opacity: 0; transform: translateY(-10px)} 100% {opacity: 1; transform: translateY(0)} }
        .progress-bar { transition: width 0.3s ease; }
        .reset-link:hover { text-decoration: underline; color: #ef4444; cursor: pointer; }
    </style>
</head>
<body class="space-y-4"> 
    <header class="flex justify-between items-end pb-3 border-b border-slate-800">
        <div>
            <div class="flex items-center gap-2">
                <span onclick="resetApiKey()" class="text-xs text-slate-500 font-bold tracking-widest reset-link" title="Click to Reset API Key">OCTODON v14.2 [RESET]</span>
                <span id="model-badge" class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-400">INITIALIZING...</span>
            </div>
            <h1 class="text-3xl cyber-font text-white leading-none mt-1">DUAL CORE</h1> 
        </div>
        <div id="clock" class="text-sm font-bold text-slate-500 cyber-font">00:00</div> 
    </header>

    <div class="grid grid-cols-3 gap-3 min-h-[8rem]">
        <div id="card-nas" class="status-box bg-slate-900 border border-slate-700 rounded-2xl p-1 flex flex-col items-center justify-center text-center relative overflow-hidden h-full">
            <div class="absolute top-2 text-[9px] text-slate-500 font-bold tracking-widest">NASDAQ</div> <div id="icon-nas" class="text-2xl mb-1">ğŸ¦…</div>
            <div id="status-nas" class="text-[10px] font-bold text-slate-600 bg-slate-950 px-2 py-1 rounded-full">NO DATA</div> 
        </div>
        <div id="card-metal" class="status-box bg-slate-900 border border-slate-700 rounded-2xl p-1 flex flex-col items-center justify-center text-center relative overflow-hidden h-full">
            <div class="absolute top-2 text-[9px] text-slate-500 font-bold tracking-widest">METALS</div>
            <div id="icon-metal" class="text-2xl mb-1">âš–ï¸</div>
            <div id="status-metal" class="text-[10px] font-bold text-slate-600 bg-slate-950 px-2 py-1 rounded-full">NO DATA</div>
        </div>
        <div id="card-roman" class="status-box bg-slate-900 border border-slate-700 rounded-2xl p-1 flex flex-col items-center justify-center text-center relative overflow-hidden h-full">
            <div class="absolute top-2 text-[9px] text-slate-500 font-bold tracking-widest">ROMAN</div>
            <div id="icon-roman" class="text-2xl mb-1">ğŸ’</div> 
            <div id="status-roman" class="text-[10px] font-bold text-slate-600 bg-slate-950 px-2 py-1 rounded-full">NO DATA</div>
        </div>
    </div>

    <button onclick="executeDualCoreScan()" id="scan-btn" class="btn-push w-full py-5 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-2xl shadow-lg shadow-indigo-900/50 flex items-center justify-center gap-3 transition-all relative overflow-hidden">
        <div id="progress-bg" class="absolute left-0 top-0 h-full bg-indigo-400/30 w-0 progress-bar"></div>
        <span class="text-2xl relative z-10">ğŸ“¡</span>
        <span id="btn-text" class="text-lg tracking-widest relative z-10">TACTICAL SCAN</span> 
    </button>

    <div class="flex-grow overflow-y-auto no-scrollbar relative">
        <details id="report-details" class="bg-slate-900/50 border border-slate-800 rounded-2xl overflow-hidden group">
            <summary class="p-3 flex justify-between items-center cursor-pointer bg-slate-800/50 hover:bg-slate-800 transition-colors">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Tactical Report</span>
                <span class="text-[10px] text-indigo-400 group-open:rotate-180 transition-transform">â–¼ OPEN</span>
            </summary>
            <div class="p-4 pt-3 border-t border-slate-800">
                <div id="system-log" class="text-xs text-indigo-400 font-mono mb-2 border-b border-slate-800 pb-2 hidden"></div>
                <div id="report-content" class="text-sm text-slate-300 leading-relaxed font-mono whitespace-pre-wrap">
ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­... æœ€é©ãªãƒ¢ãƒ‡ãƒ«ã‚’æ¢ç´¢ã—ã¾ã™ã€‚
                </div>
                <div id="report-links" class="mt-4 flex flex-wrap gap-2"></div>
            </div>
        </details>
    </div>

    <script>
        // è‡ªå‹•æ¤œå‡ºã—ãŸãƒ¢ãƒ‡ãƒ«IDã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
        let SCOUT_MODEL = ""; // Flashç›¸å½“
        let COMMANDER_MODEL = ""; // Proç›¸å½“
        let apiKey = localStorage.getItem("gemini_api_key_v2");

        async function init() {
            if (!apiKey) {
                let input = prompt("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (AIza...ã§å§‹ã¾ã‚‹ã‚­ãƒ¼)");
                if (input) { 
                    apiKey = input.trim(); 
                    localStorage.setItem("gemini_api_key_v2", apiKey);
                    location.reload();
                }
            } else {
                // ã‚­ãƒ¼ãŒã‚ã‚‹å ´åˆã€ãƒ¢ãƒ‡ãƒ«ã‚’è‡ªå‹•æ¢ç´¢
                await detectModels();
            }
            updateClock();
        }

        // --- ãƒ¢ãƒ‡ãƒ«è‡ªå‹•æ¤œå‡ºæ©Ÿèƒ½ (Auto-Detector) ---
        async function detectModels() {
            const badge = document.getElementById('model-badge');
            try {
                // åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’å–å¾—
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if (!res.ok) throw new Error("Key Error");
                
                const data = await res.json();
                const models = data.models || [];

                // æ¡ä»¶ã«åˆã†ãƒ¢ãƒ‡ãƒ«ã‚’æ¢ã™ (generateContentå¯¾å¿œå¿…é ˆ)
                const chatModels = models.filter(m => m.supportedGenerationMethods?.includes("generateContent"));

                // 1. Flashãƒ¢ãƒ‡ãƒ« (2.0å„ªå…ˆ, ãªã‘ã‚Œã°1.5, ãªã‘ã‚Œã°ä½•ã§ã‚‚)
                const flash = chatModels.find(m => m.name.includes("2.0-flash")) 
                           || chatModels.find(m => m.name.includes("1.5-flash")) 
                           || chatModels.find(m => m.name.includes("flash")) 
                           || chatModels[0];
                
                // 2. Proãƒ¢ãƒ‡ãƒ« (1.5-proå„ªå…ˆ, ãªã‘ã‚Œã°Flashã§ä»£ç”¨)
                const pro = chatModels.find(m => m.name.includes("1.5-pro")) 
                         || chatModels.find(m => m.name.includes("pro")) 
                         || flash; // ProãŒãªã„ãªã‚‰Flashã§ä»£ç”¨

                // IDã‹ã‚‰ "models/" ã‚’é™¤å»ã—ã¦ã‚»ãƒƒãƒˆ
                SCOUT_MODEL = flash.name.replace("models/", "");
                COMMANDER_MODEL = pro.name.replace("models/", "");

                badge.innerText = `LINKED: ${SCOUT_MODEL.replace("gemini-","")} / ${COMMANDER_MODEL.replace("gemini-","")}`;
                badge.className = "text-[10px] bg-indigo-900/50 text-indigo-300 px-2 py-0.5 rounded border border-indigo-800";
                
                document.getElementById('report-content').innerText = `ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†ã€‚\næ¤œå‡ºãƒ¢ãƒ‡ãƒ«:\nåµå¯Ÿ: ${SCOUT_MODEL}\næŒ‡æ®: ${COMMANDER_MODEL}`;

            } catch(e) {
                console.error(e);
                badge.innerText = "AUTH ERROR";
                badge.className = "text-[10px] bg-red-900/50 text-red-300 px-2 py-0.5 rounded border border-red-800";
                document.getElementById('report-content').innerText = "APIã‚­ãƒ¼ãŒç„¡åŠ¹ã‹ã€é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚å·¦ä¸Šã®RESETã‚’æŠ¼ã—ã¦å†è¨­å®šã—ã¦ãã ã•ã„ã€‚";
            }
        }

        function resetApiKey() {
            if(confirm("APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¦å†è¨­å®šã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem("gemini_api_key_v2");
                location.reload();
            }
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'});
        }
        setInterval(updateClock, 1000);
        setTimeout(init, 500);

        // æ±ç”¨APIå‘¼ã³å‡ºã—
        async function callGemini(model, prompt, useSearch = false) {
            if (!model) throw new Error("Model ID not initialized");
            
            const tools = useSearch ? [{ "google_search": {} }] : [];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: tools
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`API Error: ${response.status} (${errorData.error?.message || "Unknown"})`);
            }
            
            const data = await response.json();
            return {
                text: data.candidates?.[0]?.content?.parts?.[0]?.text || "",
                links: data.candidates?.[0]?.groundingMetadata?.groundingAttributions || []
            };
        }

        function updateStatus(id, color) {
            const card = document.getElementById(`card-${id}`);
            const statusText = document.getElementById(`status-${id}`);
            card.className = "status-box border rounded-2xl p-1 flex flex-col items-center justify-center text-center relative overflow-hidden h-full";
            
            if (color === "RED") {
                card.classList.add("bg-red-950/30", "border-red-500", "blink-red");
                statusText.className = "text-[10px] font-bold text-red-100 bg-red-600 px-2 py-1 rounded-full shadow-[0_0_10px_#ef4444]";
                statusText.innerText = "CRITICAL";
            } else if (color === "YELLOW") {
                card.classList.add("bg-yellow-950/20", "border-yellow-500", "glow-yellow");
                statusText.className = "text-[10px] font-bold text-yellow-100 bg-yellow-600 px-2 py-1 rounded-full shadow-[0_0_10px_#eab308]";
                statusText.innerText = "WARNING";
            } else {
                card.classList.add("bg-green-950/20", "border-green-500", "glow-green");
                statusText.className = "text-[10px] font-bold text-green-100 bg-green-600 px-2 py-1 rounded-full shadow-[0_0_10px_#22c55e]";
                statusText.innerText = "NORMAL";
            }
        }

        async function executeDualCoreScan() {
            if(!SCOUT_MODEL || !COMMANDER_MODEL) { await detectModels(); }
            if(!apiKey) return;

            const btn = document.getElementById('scan-btn');
            const btnText = document.getElementById('btn-text');
            const progress = document.getElementById('progress-bg');
            const content = document.getElementById('report-content');
            const sysLog = document.getElementById('system-log');
            const linksContainer = document.getElementById('report-links');
            const details = document.getElementById('report-details');

            btn.disabled = true;
            sysLog.classList.remove('hidden');
            sysLog.innerText = `> TARGET: ${SCOUT_MODEL} & ${COMMANDER_MODEL}`;
            content.innerText = "";
            linksContainer.innerHTML = "";
            progress.style.width = "10%";

            const now = new Date();
            const currentMonth = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ`;
            const dateString = now.toLocaleDateString('ja-JP');

            try {
                // PHASE 1: Flash Scout
                btnText.innerText = "SCOUTING...";
                
                const scouts = [
                    { id: "nas", query: `NASDAQ100 (QQQM) ${currentMonth} æ ªä¾¡ãƒ‹ãƒ¥ãƒ¼ã‚¹ å…¬å¼ç™ºè¡¨ çµŒæ¸ˆæŒ‡æ¨™` },
                    { id: "metal", query: `é‡‘ éŠ€ éŠ… ä¾¡æ ¼ æ¨ç§» ${currentMonth} åœ¨åº«` },
                    { id: "roman", query: `æ—¥æœ¬é›»æ°—ç¡å­(5214) ã‚¸ã‚§ã‚¤ãƒ†ãƒƒã‚¯ï¼£(3446) EDP(7794) æ—­ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰(6140) ä¸‰äº•é‡‘å±(5706) å¤§é˜ªãƒã‚¿ãƒ‹ã‚¦ãƒ (5726) LITE COHR MU IONQ æ±ºç®— é©æ™‚é–‹ç¤º æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹` }
                ];

                const scoutPromises = scouts.map(async (scout) => {
                    sysLog.innerText += `\n> SCOUTING: ${scout.id.toUpperCase()}...`;
                    const res = await callGemini(SCOUT_MODEL, `ä»¥ä¸‹ã®æœ€æ–°æƒ…å ±ã‚’æ¤œç´¢ã—ã€äº‹å®Ÿã®ã¿ç®‡æ¡æ›¸ãã§å ±å‘Šã›ã‚ˆï¼ˆäºˆæƒ³ç¦æ­¢ï¼‰ã€‚\næ¤œç´¢ãƒ¯ãƒ¼ãƒ‰: ${scout.query}`, true);
                    return { id: scout.id, text: res.text, links: res.links };
                });

                const scoutResults = await Promise.all(scoutPromises);
                
                progress.style.width = "60%";
                sysLog.innerText += "\n> DATA GATHERED. ANALYZING...";
                btnText.innerText = "ANALYZING...";

                let combinedIntelligence = `ç¾åœ¨æ—¥æ™‚: ${dateString}\n\n`;
                let allLinks = [];

                scoutResults.forEach(r => {
                    combinedIntelligence += `ã€SECTOR: ${r.id.toUpperCase()}ã€‘\n${r.text}\n\n`;
                    allLinks = [...allLinks, ...r.links];
                });

                // PHASE 2: Pro Commander
                const systemPrompt = `
                    ã‚ãªãŸã¯è»äº‹AIã€ŒOCTODONã€ã§ã™ã€‚
                    åµå¯Ÿéƒ¨éšŠã‹ã‚‰ä»¥ä¸‹ã®å¸‚å ´ãƒ‡ãƒ¼ã‚¿ãŒå±Šãã¾ã—ãŸã€‚
                    
                    ## æŒ‡ç¤º
                    1. æ„Ÿæƒ…çš„ãªç…½ã‚Šã‚’æ’é™¤ã—ã€äº‹å®Ÿã«åŸºã¥ã„ãŸå†·é™ãªè»äº‹å ±å‘Šèª¿ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
                    2. æš´è½ãƒªã‚¹ã‚¯ã‚„æ‚ªã„ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒã‚ã‚Œã°ã€ŒREDã€ã€æ³¨æ„ãŒå¿…è¦ãªã‚‰ã€ŒYELLOWã€ã€é †èª¿ãªã‚‰ã€ŒGREENã€ã¨åˆ¤å®šã—ã¦ãã ã•ã„ã€‚

                    ## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå³å®ˆï¼‰
                    1è¡Œç›®: FLAGS: NAS=COLOR, METAL=COLOR, ROMAN=COLOR
                    2è¡Œç›®ä»¥é™:
                    - NAS: (è¦ç´„)
                    - METAL: (è¦ç´„)
                    - ROMAN: (è¦ç´„)

                    ## ç‰¹è¨˜äº‹é …
                    é‡è¦ç™ºè¡¨ãŒã‚ã‚‹å ´åˆã®ã¿ä»¥ä¸‹å½¢å¼ã§è¿½è¨˜:
                    â­ï¸[éŠ˜æŸ„å]
                    [è©³ç´°ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³]
                    (ã‚¢ã‚¤ã‚³ãƒ³: ğŸ”¥å£²ã‚Š/æ‚ªææ–™, ğŸ’åœ°åˆã„/å¥½ææ–™, ğŸŸ¡ãã®ä»–)
                `;

                const finalReport = await callGemini(COMMANDER_MODEL, systemPrompt + "\n\n" + combinedIntelligence, false);
                
                progress.style.width = "100%";
                
                const lines = finalReport.text.split('\n');
                const flagLine = lines.find(l => l.includes("FLAGS:")) || lines[0];
                const reportBody = finalReport.text.replace(flagLine, "").trim();

                const parseColor = (key) => {
                    if (flagLine.includes(`${key}=RED`)) return "RED";
                    if (flagLine.includes(`${key}=YELLOW`)) return "YELLOW";
                    return "GREEN";
                };

                updateStatus("nas", parseColor("NAS"));
                updateStatus("metal", parseColor("METAL"));
                updateStatus("roman", parseColor("ROMAN"));

                content.innerText = reportBody;

                const uniqueLinks = Array.from(new Map(allLinks.map(item => [item.web.uri, item])).values());
                linksContainer.innerHTML = uniqueLinks.map(a => 
                    `<a href="${a.web.uri}" target="_blank" class="text-[10px] bg-slate-800 px-3 py-1.5 rounded text-indigo-400 underline inline-block mb-1 hover:text-indigo-300 transition-colors">${a.web.title?.slice(0,15)}...</a>`
                ).join('');

                if (flagLine.includes("RED") || flagLine.includes("YELLOW")) {
                    details.open = true;
                }

                sysLog.innerText += "\n> MISSION COMPLETE.";

            } catch (e) {
                console.error(e);
                content.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿï¼\n" + e.message;
                sysLog.innerText += "\n> SYSTEM ERROR DETECTED.";
                updateStatus("nas", "RED");
            } finally {
                btn.disabled = false;
                btnText.innerText = "RE-SCAN";
                progress.style.width = "0";
                setTimeout(() => sysLog.classList.add('hidden'), 5000);
            }
        }
    </script>
</body>
</html>
