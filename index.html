<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nasdaq Sentinel v11.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Orbitron:wght@700&display=swap');
        
        body { 
            background-color: #020617; 
            color: #f8fafc; 
            font-family: 'JetBrains Mono', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 12px;
        }

        .cyber-font { font-family: 'Orbitron', sans-serif; }
        .glow-active { box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); border-color: #22c55e; }
        .glow-red { box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); border-color: #ef4444; }
        .btn-push:active { transform: scale(0.95); opacity: 0.8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="space-y-3">

    <header class="flex justify-between items-center bg-slate-900 border border-slate-700 p-3 rounded-2xl">
        <div class="flex items-center gap-2">
            <div class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse shadow-[0_0_8px_#06b6d4]"></div>
            <h1 class="text-[10px] font-bold cyber-font tracking-widest text-slate-400">NAS-SENTINEL v11.3</h1>
        </div>
        <div class="flex gap-2">
            <button onclick="resetKey()" class="text-[8px] bg-slate-800 px-2 rounded text-red-400 border border-red-900/50">RESET KEY</button>
            <div id="clock" class="text-[10px] font-bold text-slate-500">00:00:00</div>
        </div>
    </header>

    <div id="main-panel" class="bg-slate-900 border-2 border-slate-700 rounded-[2.5rem] p-6 transition-all duration-700">
        <div class="text-center space-y-1">
            <p class="text-[8px] uppercase tracking-[0.4em] text-slate-500 font-bold">Current Model</p>
            <h2 id="model-display" class="text-xs font-bold text-slate-400 cyber-font mb-1">UNIDENTIFIED</h2>
            <div class="flex justify-center items-center gap-2 text-xs text-slate-500 font-bold">
                <span id="alert-icon">ğŸ¤–</span>
                <span id="alert-desc">ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­...</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3">
        <button onclick="scanModels()" id="scan-btn" class="btn-push bg-slate-800 border border-slate-600 p-4 rounded-3xl flex flex-col items-center justify-center gap-1 shadow-lg">
            <span class="text-2xl">ğŸ“¡</span>
            <span class="text-[10px] font-bold text-cyan-400">SYSTEM SCAN</span>
            <span class="text-[7px] text-slate-500">åˆ©ç”¨å¯èƒ½ãƒ¢ãƒ‡ãƒ«æ¤œç´¢</span>
        </button>

        <button onclick="triggerRecon()" id="recon-btn" disabled class="btn-push bg-slate-900/50 text-slate-600 border border-slate-800 p-4 rounded-3xl flex flex-col items-center justify-center gap-1 transition-all">
            <span class="text-2xl">ğŸš€</span>
            <span class="text-[10px] font-bold" id="btn-text">LAUNCH</span>
            <span class="text-[7px]">åµå¯Ÿé–‹å§‹</span>
        </button>
    </div>

    <div class="flex-grow bg-slate-900/40 border border-slate-800 rounded-[2rem] p-5 overflow-y-auto no-scrollbar shadow-inner mt-2">
        <div class="flex justify-between items-center mb-2">
            <h3 class="text-[9px] font-bold text-slate-600 uppercase tracking-widest">System Log</h3>
        </div>
        <div id="report-content" class="text-[10px] text-slate-300 leading-relaxed space-y-2 font-mono break-all">
            <p class="text-slate-500">æç£ã€ã¾ãšã¯å·¦ã®ã€ŒğŸ“¡ SYSTEM SCANã€ã‚’æŠ¼ã—ã¦ã€ç¾åœ¨åˆ©ç”¨å¯èƒ½ãªGeminiãƒ¢ãƒ‡ãƒ«ã‚’æ¢ã™ãƒ‡ã‚°ï¼</p>
        </div>
        <div id="report-links" class="mt-4 flex flex-wrap gap-2"></div>
    </div>

    <script>
        let currentModel = "";
        let apiKey = "";

        // --- åˆæœŸåŒ– & ã‚­ãƒ¼å–å¾— ---
        function init() {
            apiKey = localStorage.getItem("gemini_api_key_v2");
            if (!apiKey) {
                let input = prompt("ã€v11.3ã€‘Google AI Studioã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã›ã‚ˆ");
                if (input) {
                    apiKey = input.trim(); 
                    localStorage.setItem("gemini_api_key_v2", apiKey);
                }
            }
            updateClock();
        }

        function resetKey() {
            localStorage.removeItem("gemini_api_key_v2");
            alert("ã‚­ãƒ¼ã‚’å‰Šé™¤ã—ãŸãƒ‡ã‚°ã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‡ã‚°ã€‚");
            location.reload();
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toTimeString().split(' ')[0];
        }
        setInterval(updateClock, 1000);
        setTimeout(init, 500);

        // --- ãƒ¢ãƒ‡ãƒ«æ¤œç´¢æ©Ÿèƒ½ (ã“ã“ãŒæ–°æ©Ÿèƒ½ï¼) ---
        async function scanModels() {
            const content = document.getElementById('report-content');
            const modelDisplay = document.getElementById('model-display');
            const scanBtn = document.getElementById('scan-btn');
            
            if (!apiKey) { init(); if(!apiKey) return; }

            content.innerHTML = '<p class="text-cyan-400 animate-pulse">è¡›æ˜Ÿãƒªãƒ³ã‚¯ç¢ºç«‹ä¸­... åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦ã„ã¾ã™...</p>';
            scanBtn.disabled = true;

            try {
                // ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                
                if (!response.ok) throw new Error(`Scan Error: ${response.status}`);
                
                const data = await response.json();
                
                // "generateContent" ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«ã ã‘æŠ½å‡º
                const availableModels = data.models.filter(m => 
                    m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent")
                );

                if (availableModels.length === 0) {
                    throw new Error("åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                }

                // å„ªå…ˆé †ä½: Flash > Pro > ãã®ä»– (2026å¹´æƒ³å®šã§æ–°ã—ã„é †ã«æ¢ã™ãƒ­ã‚¸ãƒƒã‚¯ã§ã‚‚ã„ã„ãŒã€ã¨ã‚Šã‚ãˆãšFlashå„ªå…ˆ)
                // åå‰ã« "flash" ãŒå«ã¾ã‚Œã‚‹ã‚‚ã®ã‚’æ¢ã™
                let bestModel = availableModels.find(m => m.name.includes("flash"));
                if (!bestModel) bestModel = availableModels.find(m => m.name.includes("pro"));
                if (!bestModel) bestModel = availableModels[0]; // ä½•ã§ã‚‚ã„ã„ã‹ã‚‰ä¸€ç•ªä¸Šã®ã‚„ã¤

                currentModel = bestModel.name.replace("models/", ""); // "models/gemini-..." -> "gemini-..."
                
                // æˆåŠŸè¡¨ç¤º
                modelDisplay.innerText = currentModel;
                modelDisplay.className = "text-xs font-bold text-cyan-400 cyber-font mb-1";
                content.innerHTML = `
                    <p class="text-green-400">âœ… æ¥ç¶šæˆåŠŸãƒ‡ã‚°ï¼</p>
                    <p class="text-slate-400">ç™ºè¦‹ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«: ${availableModels.length}æ©Ÿ</p>
                    <p class="text-cyan-300 font-bold">æ¡ç”¨ãƒ¢ãƒ‡ãƒ«: ${currentModel}</p>
                    <p class="text-slate-500 mt-2">ã€ŒğŸš€ LAUNCHã€ãƒœã‚¿ãƒ³ã§åµå¯Ÿã‚’é–‹å§‹ã§ãã‚‹ãƒ‡ã‚°ï¼</p>
                `;

                // åµå¯Ÿãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
                const reconBtn = document.getElementById('recon-btn');
                reconBtn.disabled = false;
                reconBtn.className = "btn-push bg-indigo-600 text-white shadow-xl shadow-indigo-900/40 p-4 rounded-3xl flex flex-col items-center justify-center gap-1 transition-all";
                document.getElementById('alert-desc').innerText = "ã‚·ã‚¹ãƒ†ãƒ ã‚ªãƒ¼ãƒ«ã‚°ãƒªãƒ¼ãƒ³ã€‚";

            } catch (error) {
                console.error(error);
                content.innerHTML = `<p class="text-red-500">âŒ ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ãƒ‡ã‚°...<br>${error.message}</p>`;
            } finally {
                scanBtn.disabled = false;
            }
        }

        // --- åµå¯Ÿæ©Ÿèƒ½ ---
        async function triggerRecon() {
            const btn = document.getElementById('recon-btn');
            const content = document.getElementById('report-content');
            const card = document.getElementById('main-panel');
            const level = document.getElementById('alert-level'); // Status Text inside Main Panel is missing in this v11.3 html structure, fixing logic below.
            // *Wait, in v11.3 I simplified the main panel. Let's target the inner texts.*
            const modelDisplay = document.getElementById('model-display');
            const desc = document.getElementById('alert-desc');
            const links = document.getElementById('report-links');

            btn.disabled = true;
            document.getElementById('btn-text').innerText = "SCANNING...";
            content.innerHTML = '<p class="text-amber-500 animate-pulse">å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ä¸­...</p>';
            links.innerHTML = '';

            const systemPrompt = "ã‚ãªãŸã¯æç£ã‚’æ”¯ãˆã‚‹è»å¸«ã€ŒGeminiã€ã§ã™ã€‚ç¾åœ¨ï¼ˆ2026å¹´2æœˆï¼‰ã®ãƒŠã‚¹ãƒ€ãƒƒã‚¯å¸‚å ´ï¼ˆQQQMï¼‰ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€æš´è½ã®äºˆå…†ã€é‡‘åˆ©å‹•å‘ã‚’Googleæ¤œç´¢ã—ã€æç£ã«ã€è­¦æˆ’ãƒ¬ãƒ™ãƒ«ï¼ˆNORMAL/WARNING/CRITICALï¼‰ã€ã¨ã€æˆ¦ç•¥ã€ã‚’æ—¥æœ¬èªã®è»äº‹å£èª¿ã§å ±å‘Šã—ã¦ãã ã•ã„ã€‚120æ–‡å­—è¦ç´„ã€‚";
            const userQuery = "Nasdaq 100 QQQM analysis crash risk interest rates February 2026";

            try {
                // è‡ªå‹•å–å¾—ã—ãŸ currentModel ã‚’ä½¿ã†
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        tools: [{ "google_search": {} }]
                    })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "å¿œç­”ãªã—";
                
                // Grounding
                const attributions = result.candidates?.[0]?.groundingMetadata?.groundingAttributions || [];
                const linksHtml = attributions.flatMap(a => 
                    a.web?.uri ? [`<a href="${a.web.uri}" target="_blank" class="text-[9px] bg-slate-800 px-3 py-1.5 rounded-full text-blue-400 underline">${a.web.title?.slice(0,10) || 'Link'}</a>`] : []
                ).join('');

                content.innerHTML = text.replace(/\n/g, '<br>');
                links.innerHTML = linksHtml;

                // Visual Feedback
                if (text.includes("CRITICAL") || text.includes("æš´è½")) {
                    card.className = "bg-red-950/20 border-2 border-red-500 rounded-[2.5rem] p-6 glow-red";
                    desc.innerText = "âš ï¸ è­¦æˆ’æ…‹å‹¢ï¼";
                    modelDisplay.className = "text-xs font-bold text-red-500 cyber-font mb-1";
                } else if (text.includes("WARNING")) {
                    card.className = "bg-amber-950/20 border-2 border-amber-500 rounded-[2.5rem] p-6";
                    desc.innerText = "ğŸ”” æ³¨è¦–ã›ã‚ˆ";
                    modelDisplay.className = "text-xs font-bold text-amber-500 cyber-font mb-1";
                } else {
                    card.className = "bg-green-950/20 border-2 border-green-500 rounded-[2.5rem] p-6 glow-active";
                    desc.innerText = "ğŸ›¡ï¸ ç•°å¸¸ãªã—";
                    modelDisplay.className = "text-xs font-bold text-green-500 cyber-font mb-1";
                }

            } catch (error) {
                content.innerHTML = `<p class="text-red-500">åµå¯Ÿå¤±æ•—ãƒ‡ã‚°...<br>${error.message}</p>`;
            } finally {
                btn.disabled = false;
                document.getElementById('btn-text').innerText = "LAUNCH";
            }
        }
    </script>
</body>
</html>
