<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OCTODON SYSTEM v15.0 - TACTICAL MONITOR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Black+Ops+One&display=swap');
        
        body { 
            background-color: #050505; 
            color: #e2e8f0; 
            font-family: 'JetBrains Mono', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 16px;
            /* iPhoneã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢å¯¾å¿œ */
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }

        .cyber-font { font-family: 'Black Ops One', cursive; letter-spacing: 0.1em; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .status-box { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #1e293b; }
        
        /* çŠ¶æ…‹åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« */
        .status-red { 
            background: linear-gradient(135deg, rgba(69,10,10,0.8) 0%, rgba(0,0,0,0.9) 100%);
            border-color: #ef4444; 
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
            animation: pulse-red 2s infinite;
        }
        .status-yellow { 
            background: linear-gradient(135deg, rgba(66,32,6,0.8) 0%, rgba(0,0,0,0.9) 100%);
            border-color: #eab308; 
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.3);
        }
        .status-green { 
            background: linear-gradient(135deg, rgba(20,83,45,0.8) 0%, rgba(0,0,0,0.9) 100%);
            border-color: #22c55e; 
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* UIãƒ‘ãƒ¼ãƒ„ */
        .scan-btn {
            background: linear-gradient(90deg, #4f46e5 0%, #3730a3 100%);
            position: relative; overflow: hidden;
        }
        .scan-btn:active { transform: scale(0.98); }
        .scan-btn::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        .scan-btn:hover::after { left: 100%; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* ã‚¿ãƒ¼ãƒŸãƒŠãƒ«é¢¨å‡ºåŠ›ã‚¨ãƒªã‚¢ */
        .terminal-window {
            background-color: #0f172a;
            border: 1px solid #334155;
            box-shadow: inset 0 0 20px #020617;
        }
        
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="space-y-3"> 

    <header class="flex justify-between items-end pb-2 border-b border-slate-800">
        <div>
            <div class="flex items-center gap-2 mb-1">
                <span onclick="resetApiKey()" class="text-[10px] text-slate-600 hover:text-red-500 cursor-pointer font-bold tracking-widest">[RESET KEY]</span>
                <span id="model-badge" class="text-[9px] bg-slate-900 border border-slate-700 px-1.5 py-0.5 rounded text-slate-500">SYSTEM OFFLINE</span>
            </div>
            <h1 class="text-2xl cyber-font text-white leading-none tracking-tighter">OCTODON <span class="text-indigo-500">SYS.15</span></h1> 
        </div>
        <div class="text-right">
            <div class="text-[9px] text-slate-500">JST (TOKYO)</div>
            <div id="clock" class="text-xl font-bold text-slate-400 cyber-font">00:00:00</div> 
        </div>
    </header>

    <div class="grid grid-cols-2 gap-2 h-32 md:h-40">
        <div id="card-nas" class="status-box bg-slate-900 rounded-lg flex flex-col items-center justify-center relative">
            <div class="absolute top-1 left-2 text-[8px] text-slate-500 tracking-widest">SECTOR 01</div>
            <div class="text-lg mb-1">ğŸ¦…</div>
            <div class="text-xs font-bold text-slate-300">NASDAQ</div>
            <div id="status-nas" class="mt-1 text-[9px] px-2 py-0.5 bg-slate-950 rounded text-slate-600">WAITING</div> 
        </div>
        <div id="card-metal" class="status-box bg-slate-900 rounded-lg flex flex-col items-center justify-center relative">
            <div class="absolute top-1 left-2 text-[8px] text-slate-500 tracking-widest">SECTOR 02</div>
            <div class="text-lg mb-1">âš–ï¸</div>
            <div class="text-xs font-bold text-slate-300">COMMODITY</div>
            <div id="status-metal" class="mt-1 text-[9px] px-2 py-0.5 bg-slate-950 rounded text-slate-600">WAITING</div>
        </div>
        <div id="card-jp" class="status-box bg-slate-900 rounded-lg flex flex-col items-center justify-center relative">
            <div class="absolute top-1 left-2 text-[8px] text-slate-500 tracking-widest">SECTOR 03</div>
            <div class="text-lg mb-1">ğŸ–ï¸</div>
            <div class="text-xs font-bold text-slate-300">JP FORCE</div>
            <div id="status-jp" class="mt-1 text-[9px] px-2 py-0.5 bg-slate-950 rounded text-slate-600">WAITING</div>
        </div>
        <div id="card-us" class="status-box bg-slate-900 rounded-lg flex flex-col items-center justify-center relative">
            <div class="absolute top-1 left-2 text-[8px] text-slate-500 tracking-widest">SECTOR 04</div>
            <div class="text-lg mb-1">ğŸ‡ºğŸ‡¸</div>
            <div class="text-xs font-bold text-slate-300">US FORCE</div>
            <div id="status-us" class="mt-1 text-[9px] px-2 py-0.5 bg-slate-950 rounded text-slate-600">WAITING</div>
        </div>
    </div>

    <button onclick="executeMission()" id="scan-btn" class="scan-btn w-full py-4 text-white font-bold rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all group">
        <span class="text-xl group-hover:rotate-90 transition-transform duration-500">âœœ</span>
        <span id="btn-text" class="text-sm tracking-[0.2em] font-bold">INITIATE SCAN</span> 
        <div id="progress-bar" class="absolute bottom-0 left-0 h-1 bg-cyan-400 w-0 transition-all duration-300"></div>
    </button>

    <div class="flex-grow overflow-hidden flex flex-col">
        <div class="terminal-window rounded-lg flex-grow flex flex-col overflow-hidden relative">
            <div id="system-log" class="p-2 border-b border-slate-700 bg-slate-950 text-[10px] text-green-500 font-mono h-24 overflow-y-auto">
                > SYSTEM READY.<br>
                > AWAITING COMMAND...
            </div>
            <div class="flex-grow overflow-y-auto p-3 text-xs leading-relaxed text-slate-300 whitespace-pre-wrap font-mono no-scrollbar" id="report-content">
(ã“ã“ã«æˆ¦æ³å ±å‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™)
            </div>
        </div>
    </div>

    <script>
        // --- è¨­å®šå¤‰æ•° ---
        let apiKey = localStorage.getItem("octdon_api_key");
        let SCOUT_MODEL = "gemini-1.5-flash"; // é€Ÿåº¦å„ªå…ˆ
        let COMMANDER_MODEL = "gemini-1.5-pro"; // è³¢ã•å„ªå…ˆ
        
        // --- åˆæœŸåŒ–å‡¦ç† ---
        async function init() {
            updateClock();
            setInterval(updateClock, 1000);

            if (!apiKey) {
                const input = prompt("OCTODON SYSTEM: APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (AIza...)");
                if (input && input.startsWith("AIza")) {
                    apiKey = input.trim();
                    localStorage.setItem("octdon_api_key", apiKey);
                    log("API KEY SAVED.");
                    detectModels();
                } else {
                    log("ERROR: API KEY REQUIRED.");
                }
            } else {
                detectModels();
            }
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('ja-JP');
        }

        function log(msg) {
            const el = document.getElementById('system-log');
            el.innerHTML += `> ${msg}<br>`;
            el.scrollTop = el.scrollHeight;
        }

        function resetApiKey() {
            if(confirm("èªè¨¼æƒ…å ±ã‚’ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem("octdon_api_key");
                location.reload();
            }
        }

        // --- ãƒ¢ãƒ‡ãƒ«è‡ªå‹•æ¤œå‡º ---
        async function detectModels() {
            const badge = document.getElementById('model-badge');
            badge.innerText = "CONNECTING...";
            try {
                // ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦ã€åˆ©ç”¨å¯èƒ½ãªæœ€æ–°ãƒ¢ãƒ‡ãƒ«ã‚’æ¢ã™
                const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error("Connection Failed");
                const data = await res.json();
                
                // Flashç³»ã¨Proç³»ã‚’æ¢ã™
                const flash = data.models.find(m => m.name.includes("2.0-flash")) || data.models.find(m => m.name.includes("1.5-flash"));
                const pro = data.models.find(m => m.name.includes("1.5-pro")) || flash; // ProãŒãªã‘ã‚Œã°Flashã§ä»£ç”¨

                if(flash) SCOUT_MODEL = flash.name.replace("models/", "");
                if(pro) COMMANDER_MODEL = pro.name.replace("models/", "");

                badge.innerText = `LINKED: ${SCOUT_MODEL.split('-')[1].toUpperCase()} / ${COMMANDER_MODEL.split('-')[1].toUpperCase()}`;
                badge.className = "text-[9px] bg-indigo-900 border border-indigo-500 px-1.5 py-0.5 rounded text-indigo-300";
                log(`SCOUT UNIT: ${SCOUT_MODEL}`);
                log(`COMMANDER: ${COMMANDER_MODEL}`);

            } catch(e) {
                badge.innerText = "AUTH ERROR";
                badge.className = "text-[9px] bg-red-900 border border-red-500 px-1.5 py-0.5 rounded text-red-300";
                log(`ERROR: ${e.message}`);
            }
        }

        // --- Gemini API å‘¼ã³å‡ºã—é–¢æ•° ---
        async function callGemini(model, text, useSearch = false) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: text }] }]
            };
            if (useSearch) {
                payload.tools = [{ google_search: {} }];
            }

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                if(res.status === 429) throw new Error("Rate Limit Exceeded (429)");
                throw new Error(`API Error ${res.status}`);
            }

            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "No Response";
        }

        // --- ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œå‡¦ç† ---
        async function executeMission() {
            const btn = document.getElementById('scan-btn');
            const btnText = document.getElementById('btn-text');
            const pBar = document.getElementById('progress-bar');
            
            if(!apiKey) return alert("API Key not set");

            // UIãƒªã‚»ãƒƒãƒˆ
            btn.disabled = true;
            document.querySelectorAll('.status-box').forEach(el => el.className = 'status-box bg-slate-900 rounded-lg flex flex-col items-center justify-center relative'); // ã‚¯ãƒ©ã‚¹åˆæœŸåŒ–
            ['nas','metal','jp','us'].forEach(id => document.getElementById(`status-${id}`).innerText = "SCANNING...");
            
            try {
                // æ—¥ä»˜è¨ˆç®—
                const now = new Date();
                const dateStr = now.toLocaleDateString('ja-JP');
                const prevDate = new Date(now);
                prevDate.setDate(prevDate.getDate() - 3); // å¿µã®ãŸã‚3æ—¥å‰ã‹ã‚‰æ¤œç´¢å¯¾è±¡ã«ï¼ˆé€±æœ«ã¾ãŸãå¯¾ç­–ï¼‰
                const afterStr = `after:${prevDate.toISOString().split('T')[0]}`;

                // PHASE 1: åµå¯Ÿéƒ¨éšŠ (Scouts) - Flashãƒ¢ãƒ‡ãƒ«
                btnText.innerText = "PHASE 1: SCOUTING";
                pBar.style.width = "20%";
                log("DEPLOYING SCOUTS...");

                // ã‚¯ã‚¨ãƒªå®šç¾© (JP/USåˆ†å‰²ç‰ˆ)
                const queries = [
                    { id: "nas", q: `NASDAQ100 S&P500 ${afterStr} æ ªä¾¡ ãƒ‹ãƒ¥ãƒ¼ã‚¹ (Open High Low Close)` },
                    { id: "metal", q: `Gold Silver Copper price ${afterStr} (Open High Low Close)` },
                    { id: "jp", q: `æ—¥æœ¬é›»æ°—ç¡å­(5214) ã‚¸ã‚§ã‚¤ãƒ†ãƒƒã‚¯ï¼£(3446) EDP(7794) æ—­ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰(6140) ä¸‰äº•é‡‘å±(5706) å¤§é˜ªãƒã‚¿ãƒ‹ã‚¦ãƒ (5726) æ ªä¾¡ æ±ºç®— ${afterStr} (å§‹å€¤ é«˜å€¤ å®‰å€¤ çµ‚å€¤)` },
                    { id: "us", q: `LITE COHR MU IONQ stock price news ${afterStr} (Open High Low Close)` }
                ];

                let scoutReport = `REPORT DATE: ${dateStr}\n\n`;

                // 4éƒ¨éšŠã‚’é †ç•ªã«å®Ÿè¡Œ (APIåˆ¶é™å›é¿ã®ãŸã‚ä¸¦åˆ—ã§ã¯ãªãç›´åˆ—æ¨å¥¨)
                for (let i = 0; i < queries.length; i++) {
                    const s = queries[i];
                    log(`>> SCANNING SECTOR: ${s.id.toUpperCase()}...`);
                    
                    // ã‚¦ã‚§ã‚¤ãƒˆã‚’å…¥ã‚Œã‚‹ (1ç§’)
                    await new Promise(r => setTimeout(r, 1000));
                    
                    const res = await callGemini(SCOUT_MODEL, `ä»¥ä¸‹ã®æœ€æ–°æƒ…å ±ã‚’æ¤œç´¢ã—ã€æ•°å€¤ãƒ‡ãƒ¼ã‚¿(OHLC)ã¨ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’äº‹å®Ÿã®ã¿ç®‡æ¡æ›¸ãã›ã‚ˆã€‚\næ¤œç´¢: ${s.q}`, true);
                    scoutReport += `ã€SECTOR: ${s.id.toUpperCase()}ã€‘\n${res}\n\n`;
                    pBar.style.width = `${20 + (i+1)*15}%`;
                }

                // PHASE 2: æŒ‡æ®å®˜åˆ†æ (Commander) - Proãƒ¢ãƒ‡ãƒ«
                btnText.innerText = "PHASE 2: TACTICAL ANALYSIS";
                log("UPLOADING DATA TO COMMANDER...");
                
                const systemPrompt = `
ã‚ãªãŸã¯è»äº‹AIã€ŒOCTODONã€ã§ã™ã€‚åµå¯Ÿéƒ¨éšŠã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€è»äº‹å ±å‘Šæ›¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## é‡è¦æŒ‡ä»¤: ãƒ­ãƒ¼ã‚½ã‚¯è¶³åˆ†æï¼ˆè¡Œã£ã¦æ¥ã„åˆ¤å®šï¼‰
å„ã‚»ã‚¯ã‚¿ãƒ¼ã«ã¤ã„ã¦ã€**ã€Œçµ‚å€¤ã€ã ã‘ã§ãªãã€Œæ—¥ä¸­å¤‰å‹•å¹…ï¼ˆHigh - Lowï¼‰ã€**ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- ã‚‚ã—ã€Œå®Ÿä½“ï¼ˆå§‹å€¤-çµ‚å€¤ï¼‰ã€ãŒå°ã•ã„ã®ã«ã€ã€Œå¤‰å‹•å¹…ã€ãŒå¤§ãã„å ´åˆï¼ˆé•·ã„ãƒ’ã‚²ã‚„åå­—ç·šï¼‰ã¯ã€**ã€æˆ¦æ³ã®è† ç€ã€**ã¾ãŸã¯**ã€æ”»å‹¢ã®å¤±æ•—ï¼ˆReversalï¼‰ã€**ã¨åˆ¤å®šã—ã¦ãã ã•ã„ã€‚

## å‡ºåŠ›ãƒ«ãƒ¼ãƒ«
1è¡Œç›®ã«å¿…ãšä»¥ä¸‹ã®ãƒ•ãƒ©ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨:
FLAGS: NAS=[COLOR], METAL=[COLOR], JP=[COLOR], US=[COLOR]
â€» COLORã¯ RED(å±é™º), YELLOW(æ³¨æ„), GREEN(é †èª¿) ã®ã„ãšã‚Œã‹ã€‚

## ãƒ¬ãƒãƒ¼ãƒˆæœ¬æ–‡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
### ğŸ“Š SECTOR: NAS
- çŠ¶æ³: (ç°¡æ½”ãªæˆ¦æ³)
... (ä»¥ä¸‹ã€METAL, JP, USã¨ç¶šã)

## ç‰¹è¨˜äº‹é …
é‡è¦ãªå‹•ãï¼ˆæš´é¨°ãƒ»æš´è½ãƒ»è¡Œã£ã¦æ¥ã„ï¼‰ãŒã‚ã‚‹éŠ˜æŸ„ã®ã¿:
â­ï¸ [éŠ˜æŸ„å] : [åˆ¤å®šã‚¢ã‚¤ã‚³ãƒ³] [è©³ç´°]
(ã‚¢ã‚¤ã‚³ãƒ³: ğŸ”¥æ•µè¥²/å£²ã‚Š, ğŸ’è£œçµ¦/è²·ã„, ğŸ”„æŠ¼ã—æˆ»ã—/è¡Œã£ã¦æ¥ã„, ğŸŸ¡è† ç€)
`;
                
                const analysis = await callGemini(COMMANDER_MODEL, systemPrompt + "\n\n" + scoutReport, false);
                pBar.style.width = "100%";
                log("MISSION COMPLETE.");

                // çµæœã®ãƒ‘ãƒ¼ã‚¹ã¨è¡¨ç¤º
                const lines = analysis.split('\n');
                const flagLine = lines.find(l => l.includes("FLAGS:")) || "";
                
                // ãƒ•ãƒ©ã‚°è§£æé–¢æ•°
                const getColor = (key) => {
                    if (flagLine.includes(`${key}=RED`)) return "red";
                    if (flagLine.includes(`${key}=YELLOW`)) return "yellow";
                    return "green";
                };

                // UIæ›´æ–°
                ['nas','metal','jp','us'].forEach(id => {
                    const color = getColor(id.toUpperCase());
                    const statusText = color === 'red' ? 'CRITICAL' : (color === 'yellow' ? 'WARNING' : 'CLEAR');
                    const el = document.getElementById(`card-${id}`);
                    const badge = document.getElementById(`status-${id}`);
                    
                    // ã‚¯ãƒ©ã‚¹é©ç”¨
                    el.classList.add(`status-${color}`);
                    badge.innerText = statusText;
                    
                    // ãƒãƒƒã‚¸ã®è‰²èª¿æ•´
                    if(color === 'red') badge.className = "mt-1 text-[9px] px-2 py-0.5 bg-red-600 text-white rounded font-bold";
                    if(color === 'yellow') badge.className = "mt-1 text-[9px] px-2 py-0.5 bg-yellow-600 text-black rounded font-bold";
                    if(color === 'green') badge.className = "mt-1 text-[9px] px-2 py-0.5 bg-green-600 text-white rounded font-bold";
                });

                // ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤ºï¼ˆFLAGSè¡Œã‚’é™¤å»ï¼‰
                document.getElementById('report-content').innerText = analysis.replace(flagLine, "").trim();

            } catch (e) {
                console.error(e);
                log(`FATAL ERROR: ${e.message}`);
                document.getElementById('report-content').innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚\n" + e.message;
            } finally {
                btn.disabled = false;
                btnText.innerText = "RE-SCAN";
                setTimeout(() => { pBar.style.width = "0%"; }, 1000);
            }
        }

        // èµ·å‹•
        window.onload = init;
    </script>
</body>
</html>
